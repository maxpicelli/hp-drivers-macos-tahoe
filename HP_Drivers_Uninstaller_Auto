#!/bin/bash

# HP Drivers Uninstaller - Executável Auto-Sudo
# Versão: 3.4.0
# Compatível com macOS Sonoma

# Função para verificar e solicitar privilégios de administrador
check_and_request_sudo() {
    if [ "$EUID" -ne 0 ]; then
        echo "=== Desinstalador de Drivers HP ==="
        echo "Versão: 3.4.0"
        echo ""
        echo "Este desinstalador precisa de privilégios de administrador."
        echo "Solicitando permissão..."
        echo ""
        
        # Executar o script novamente com sudo
        exec sudo "$0" "$@"
    fi
}

# Verificar privilégios de administrador
check_and_request_sudo

# Detectar o diretório onde o executável está localizado
EXECUTABLE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "=== Desinstalador de Drivers HP ==="
echo "Versão: 3.4.0"
echo "Diretório do executável: $EXECUTABLE_DIR"
echo ""

echo "Iniciando desinstalação dos drivers HP..."
echo ""

# Função para desinstalar com confirmação
uninstall_with_confirm() {
    local path="$1"
    local description="$2"
    
    if [ -e "$path" ]; then
        echo "Removendo: $description"
        echo "Caminho: $path"
        read -p "Confirmar remoção? (s/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Ss]$ ]]; then
            rm -rf "$path"
            echo "✓ Removido: $description"
        else
            echo "⚠ Mantido: $description"
        fi
    else
        echo "⚠ Não encontrado: $description"
    fi
}

# Função para restaurar backup
restore_backup() {
    local path="$1"
    local description="$2"
    
    # Procurar por backups
    for backup in "${path}".backup.*; do
        if [ -e "$backup" ]; then
            echo "Backup encontrado: $backup"
            read -p "Restaurar backup de $description? (s/N): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Ss]$ ]]; then
                rm -rf "$path" 2>/dev/null
                mv "$backup" "$path"
                echo "✓ Backup restaurado: $description"
            else
                echo "⚠ Backup mantido: $backup"
            fi
            return
        fi
    done
    echo "⚠ Nenhum backup encontrado para: $description"
}

# 1. Descarregar kernel extension
echo "1. Descarregando kernel extension..."
if kextstat | grep -q "hp_io_enabler_compound"; then
    echo "Descarregando kext..."
    kextunload "/Library/Extensions/hp_io_enabler_compound.kext" 2>/dev/null
    echo "✓ Kernel extension descarregado"
else
    echo "⚠ Kernel extension não estava carregado"
fi

# 2. Remover kernel extension
echo ""
echo "2. Removendo kernel extension..."
uninstall_with_confirm "/Library/Extensions/hp_io_enabler_compound.kext" "Kernel Extension HP"

# 3. Remover drivers de impressora
echo ""
echo "3. Removendo drivers de impressora..."
uninstall_with_confirm "/Library/Printers/hp" "Drivers de Impressora HP"

# 4. Remover aplicações Image Capture
echo ""
echo "4. Removendo aplicações Image Capture..."
uninstall_with_confirm "/Library/Image Capture/Devices" "Aplicações Image Capture HP"

# 5. Remover backends CUPS
echo ""
echo "5. Removendo backends CUPS..."
if [ -f "/usr/libexec/cups/backend/hpfax" ]; then
    echo "Removendo backend hpfax..."
    read -p "Confirmar remoção? (s/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Ss]$ ]]; then
        rm -f "/usr/libexec/cups/backend/hpfax"
        echo "✓ Backend hpfax removido"
    else
        echo "⚠ Backend hpfax mantido"
    fi
else
    echo "⚠ Backend hpfax não encontrado"
fi

if [ -f "/usr/libexec/cups/backend/hpFaxbackend" ]; then
    echo "Removendo backend hpFaxbackend..."
    read -p "Confirmar remoção? (s/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Ss]$ ]]; then
        rm -f "/usr/libexec/cups/backend/hpFaxbackend"
        echo "✓ Backend hpFaxbackend removido"
    else
        echo "⚠ Backend hpFaxbackend mantido"
    fi
else
    echo "⚠ Backend hpFaxbackend não encontrado"
fi

# 6. Restaurar backups (opcional)
echo ""
echo "6. Restaurar backups dos arquivos originais?"
echo "Esta opção restaura os arquivos que foram substituídos durante a instalação."
echo ""

restore_backup "/Library/Extensions/hp_io_enabler_compound.kext" "Kernel Extension HP"
restore_backup "/Library/Printers/hp" "Drivers de Impressora HP"
restore_backup "/Library/Image Capture/Devices" "Aplicações Image Capture HP"

# 7. Reiniciar serviços CUPS
echo ""
echo "7. Reiniciando serviços de impressão..."
launchctl unload /System/Library/LaunchDaemons/org.cups.cupsd.plist 2>/dev/null
launchctl load /System/Library/LaunchDaemons/org.cups.cupsd.plist
echo "✓ Serviços de impressão reiniciados"

echo ""
echo "=== Desinstalação Concluída ==="
echo ""
echo "Os drivers HP foram removidos com sucesso!"
echo ""
echo "Próximos passos:"
echo "1. Reinicie o sistema para garantir que todas as mudanças sejam aplicadas"
echo "2. Se você restaurou backups, os arquivos originais foram restaurados"
echo ""
echo "Se você quiser reinstalar os drivers HP:"
echo "- Execute: ./HP_Drivers_Installer_Auto"
